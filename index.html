<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transit Bunny</title>  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />  
  <link rel="stylesheet" href="style.css" />  
  <link href="https://fonts.googleapis.com/css?family=Fredoka+One&display=swap" rel="stylesheet">
</head>
<body>
  <div id="map"></div>
  
  <!-- Notification Popup -->
  <div id="transitScorePopup" style="display:none;"></div>
  
  <div id="controls" >
  <div class="main-menu-title-row">
    <img id="mainLogo" src="TransitBunnyLogo.png" alt="Logo" />
    <div id="transitbunnylogo" class="main-menu-title">Transit Bunny</div>
  </div>
  
  <div class="gtfs-source-row">
    <span id="dataSourceLabel" style="font-size:1.1em; color:#001df5; margin-bottom:-5px;">
      GTFS Source:
    </span>
    <span id="dataSourceText" style="font-size:0.98em; color:#0078d7; margin-bottom:0px; margin-left:8px;">
      Default - Vancouver 2025-08-08
    </span>
  </div>
  <div class="main-menu-upload">
    <button id="uploadGtfsBtn"><span style="font-size:1.2em;">üìÅ</span> Load My Own GTFS ZIP</button>
    <input type="file" id="gtfsFileInput" accept=".zip" style="display:none" />
  </div>

  <span id="dataSourceLabel" style="font-size:1.1em; color:#001df5; margin-bottom:-5px; display:block;">
    Trip Filters:
  </span>
  <div class="main-menu-filters">
    
    <!-- Route Type Filter -->
    <div class="filter-row">
      <label for="routeTypeSelect" class="filter-label">
        <span class="tooltip">
          Route Type:
          <span class="tooltiptext">
            Route Type Typically has the following nomenclature:<br>1 = Subway/Metro<br>2 = Rail<br>3 = Bus<br>4 = Ferry<br>MultiSelect is available
          </span>
        </span>
      </label>
      <select id="routeTypeSelect" multiple size="4" class="filter-select" style="min-width: 120px;"></select>
      <button type="button" id="selectAllRouteType" class="select-all-btn">Select All</button>
    </div>

    <!-- Route Name Filter -->
    <div class="filter-row">
      <label for="routeShortNameSelect" class="filter-label">
        <span class="tooltip">
          Route Name:
          <span class="tooltiptext">
            Route Name is the name of the route, such as "Red Line" or "180".<br>MultiSelect is available
          </span>
        </span>
      </label>
      <select id="routeShortNameSelect" multiple size="4" class="filter-select"style="min-width: 120px;"></select>
      <button type="button" id="selectAllRouteName" class="select-all-btn">Select All</button>
    </div>


    <!-- Service Pattern ID Filter -->
    <label id="serviceIdLabel" class="filter-label" style="display:none;">
      <span class="tooltip">
        Service Pattern ID:    
        <span class="tooltiptext">
          Service Pattern ID is a unique identifier for the service pattern defined in the Calendar or Calendar_date file.<br>MultiSelect is available
        </span>
      </span>
      <select id="serviceIdSelect" multiple size="4" style="min-width: 120px;"></select>
    </label>
    <!-- Service-Date Filter (pre-defined, hidden by default) -->
    
    <div class="filter-row">            
      <label id="serviceDateLabel" class="filter-label">
        <span class="tooltip">
          Service-Date:
          <span class="tooltiptext">
            Select a specific date or a generic weekday to filter trips by service availability.
          </span>
        </span>
      </label>
      <select id="serviceDateSelect" multiple size="4" class="filter-select" style="min-width: 120px;"></select>
    </div>

    <div id="updateButtonRow" class="filter-row">
      <button id="updateMapBtn" style="margin-top:10px;">Update Map</button>
      <label class="inline-checkbox">
        <input type="checkbox" id="aggregateStops" />
        <span>Cluster Stops?</span>
      </label>
    </div>
  </div>
</div>

<div id="progressBarContainer" style="display:none;">
  <div id="progressBar"></div>
  <span id="progressBarText" style="position:absolute; width:100%; text-align:center; left:0; top: 3.5px;line-height:28px; font-weight:bold; font-size:1.1em;">0%</span>
</div>
<div id="uiBlockOverlay" style="display:none;"></div>

<!-- Animation Controls Canvas -->
<div id="animationCanvas" class="floating-canvas" style="display:none;">
  <div class="canvas-header">
    Animation Controls
    <button class="close-canvas-btn" title="Close" style="margin-left:auto; background:none; border:none; color:#fff; font-size:1.3em; cursor:pointer;">‚úñ</button>
  </div>
  <div class="canvas-content">
    <div class="row-controls">
      <label for="speedSelect">Speed:</label>
      <select id="speedSelect">
        <option value="1">1x</option>
        <option value="10" selected>10x</option>
        <option value="60">60x</option>
        <option value="300">300x</option>
      </select>
      <span id="timeDisplay">00:00:00</span>
    </div>
    <div class="row-buttons">
      <button id="playBtn"> ‚ñ∂Ô∏è <span class="btn-label">Play</span> </button>
      <button id="pauseButton">‚èØÔ∏è <span class="btn-label">Pause</span> </button>
      <button id="stopBtn"> ‚èπÔ∏è <span class="btn-label">Stop</span></button>
    </div>
  </div>
</div>


  <!-- Graphs Canvas with Tabs -->
<div id="graphsCanvas" class="floating-canvas resizable-canvas" style="display:none;">
  <div class="canvas-header">
    <button class="tab-btn active" data-tab="tripPlotTab"># of Vehicles</button>
    <button class="tab-btn" data-tab="vehKmPlotTab">Vehicle-Kilometer</button>
    <button class="tab-btn" data-tab="tripsPerHourTab">Headway</button>
    <button class="close-canvas-btn" title="Close" style="margin-left:auto; background:none; border:none; color:#fff; font-size:1.3em; cursor:pointer;">‚úñ</button>
  </div>
  <div class="canvas-content">
    <div id="tripPlotTab" class="tab-content active">
      <canvas id="tripPlot"></canvas>
    </div>
    <div id="vehKmPlotTab" class="tab-content">
      <canvas id="vehKmPlot"></canvas>
    </div>
    <!-- trips per hour plot -->
    <div id="tripsPerHourTab" class="tab-content">
      <div id="tripsPerHourAnnotation" style="color: #b00; display:none"></div>

      <!-- changed: wrapper with headway help icon + tooltip -->
      <div class="trips-per-hour-chart-wrapper" style="position:relative;">
        <span class="headway-help" role="button" aria-label="Headway help" tabindex="0">?
          <span class="help-tooltiptext" role="tooltip">
            The headway is estimated by the number of trips scheduled in this hour. If the route contains multiple patterns with different lengths, they are weighted to the most common trip pattern. For example, if the most common trip pattern of the route is 30 km, a 60 km trip would count as 2 trips in estimating the line headway.
          </span>
        </span>

        <canvas id="tripsPerHourPlot"></canvas>
      </div>
    </div>
  </div>
  <div id = "graphResizer" class="resizer"></div>
</div>

<!-- Statistics Canvas with Tabs -->
<div id="statsCanvas" class="floating-canvas resizable-canvas" style="display:none;">
  <div class="canvas-header">
    <button class="tab-btn active" data-tab="routeStatsTab">Route Statistics</button>
    <button class="tab-btn" data-tab="compareServiceDatesTab">Compare Two Service-Dates</button>
    <button class="close-canvas-btn" title="Close" style="margin-left:auto; background:none; border:none; color:#fff; font-size:1.3em; cursor:pointer;">‚úñ</button>
  </div>

  <!--Route Stat tabs -->
  <div class="canvas-content">
    <div id="routeStatsTab" class="tab-content active">
      <button id="GenerateStat">Generate Statistics</button>
      <button id="DownloadStat">Download CSV</button>
      <div id="routeStatsTableWrapper">
        <div id="routeStatsTable"></div>
      </div>
    </div>
    <!-- Compare Services tabs -->
    <div id="compareServiceDatesTab" class="tab-content">
      <div style="display:flex; gap:12px; align-items:flex-end; margin-bottom:10px;">
        <label>
          Service-Date 1:
          <select id="compareServiceDate1" style="min-width:120px;"></select>
        </label>
        <label>
          Service-Date 2:
          <select id="compareServiceDate2" style="min-width:120px;"></select>
        </label>
        <button id="compareServiceDatesBtn" style="margin-left:16px;">Compare Service-Date</button>
      </div>
      <div id="compareServiceDatesTableWrapper">
        <div id="compareServiceDatesTable"></div>
      </div>
    </div>
  </div>
  <div class="resizer"></div>
</div>

<!-- Transit Accessibility Score Canvas-->
<div id="transitScoreCanvas" class="floating-canvas" style="display:none;">
  <div class="canvas-header" style="background: #43cea2; color: #fff;">
    Transit Accessibility Score
    <button class="close-canvas-btn" style="margin-left:auto; background:none; border:none; color:#fff; font-size:1.3em; cursor:pointer;">‚úñ</button>
  </div>
  <div class="canvas-content" style="display:flex; flex-direction:column; align-items:center; justify-content:top; height:100%;">
    <div id="transitScoreValue" >
      <span style="color:#aaa;">Click a location on the map</span>
    </div>
    <div id="transitScoreSub" style="color:#555; margin-bottom: 10px;">
      <span style="color:#43cea2;"></span> The score reflects how easy it is to access frequent transit from this spot. This feature was made for fun and there's no research-proven formula behind it! The scoring considers distance to services, number of routes, and service frequency<br>
    </div>
  </div>
</div>

<div id="helpCanvas" class="floating-canvas" style="display:none; max-width: 700px;">
  <div class="canvas-header">
    Help &amp; Instructions
    <button class="close-canvas-btn" style="margin-left:auto; background:none; border:none; color:#fff; font-size:1.3em; cursor:pointer;">‚úñ</button>
  </div>
  <!-- changed: clearer hierarchical help content with section headers matching ribbon/canvases -->
  <div class="canvas-content">
    <h3><strong>Welcome to Transit Bunny!</strong></h3>
    <p>A tool that lets you unpack GTFS transit schedule.</p>

    <h4><strong>Loading Data</strong></h4>
    <ul>
      <li>The page starts with a default Vancouver GTFS dataset from August 2025</li>
      <li>To load your own data to explore: click <strong>Load My Own GTFS ZIP</strong>. Nearly all transit agencies publish their gtfs on the web as a zip file, and usually this zip file can be used directly here.
        The zip file should contain the typical GTFS files including:</li>
        <ul>
          <li>routes.txt</li>
          <li>trips.txt</li>
          <li>shapes.txt</li>
          <li>stop_times.txt</li>
          <li>etc.</li>
        </ul>
    </ul>

    <h4><strong>Trip Filters</strong></h4>
    <ul>
      <li>Use <strong>Route Type</strong>, <strong>Route Name</strong>, and <strong>Service/Date</strong> to limit which trips are shown and animated.</li>
      <li>Multi-select is supported ‚Äî pick up to two service-dates for side-by-side comparison.</li>
      <li> [Optional] Click <strong>Update Map</strong> after changing filters to refresh stops and route shapes.</li>
    </ul>

    <h4><strong>Animation</strong></h4>
    <ul>
      <li>Open <strong>Animation</strong> (ribbon) to access playback controls: Play, Pause/Resume, Stop and Speed.</li>      
    </ul>

    <h4><strong>Graphs</strong></h4>
    <ul>
      <li> There are 3 plots available: number of vehicles over time, vehicle‚Äëkilometers, and headways.</li>
      <li> Graphs update in sync with animation progress [i.e. a complete graph requires a complete animation] </li>
    </ul>

    <h4><strong>Statistics</strong></h4>
    <ul>
      <li> Generate route-specific statistics, or compare service dates to see their difference</li>
      <li> This could be helpful for analyzing the magnitude of service changes between two dates!</li>
    </ul>

    <h4><strong>Transit Score</strong></h4>
    <ul>
      <li> Click any map location to compute an accessibility score </li>
      <li> This score is an approximation intended for quick exploration and not a formal metric!</li>
    </ul>

    <p style="font-size:0.95em; color:#2400f3;">
      Want more features or help? Contact me (Luke Li) on
      <a href="https://www.linkedin.com/in/luke-li-05445086/" target="_blank" style="color:#0078d7; text-decoration:underline;">LinkedIn</a>.
    </p>
    <img src="barcode_linkedin_lukeli.jpg" alt="Barcode" style="display:block; margin: 18px auto 0 auto; max-width:220px;">
  </div>
</div>

<!-- Add after other floating canvases -->
<div id="shapeInfoCanvas" class="floating-canvas" style="display:none; min-width:220px; max-width:90vw; z-index:2500;">
  <div class="canvas-header" style="background:#0078d7; color:#fff;">
    Route Info
    <button class="close-canvas-btn" style="margin-left:auto;">‚úñ</button>
  </div>
  <div class="canvas-content" id="shapeInfoContent" style="padding:18px; font-size:1em;"></div>
</div>

<!-- Ribbon/Taskbar at bottom -->
<div id="ribbonPanel">
  <div class="ribbon-btn">
    <button class="ribbon-icon" data-canvas="animationCanvas" title="Animation Controls">‚ñ∂Ô∏è</button>
    <div class="ribbon-label">Animation</div>
  </div>
  <div class="ribbon-btn">
    <button class="ribbon-icon" data-canvas="graphsCanvas" title="Graphs">üìà</button>
    <div class="ribbon-label">Graphs</div>
  </div>
  <div class="ribbon-btn">
    <button class="ribbon-icon" data-canvas="statsCanvas" title="Statistics">üìä</button>
    <div class="ribbon-label">Statistics</div>
  </div>
  <div class="ribbon-btn">
    <button class="ribbon-icon" data-canvas="transitScoreCanvas" title="Transit Accessibility Score">‚≠ê</button>
    <div class="ribbon-label">Transit Score</div>
  </div>
  <div class="ribbon-btn">
    <button class="ribbon-icon" data-canvas="helpCanvas" title="Help">‚ùì</button>
    <div class="ribbon-label">Help</div>
  </div>
</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Your main GTFS JS -->
  <script src="libs/chart.js"></script>
  <script src="libs/chartjs-plugin-zoom.js"></script>
  <script src="libs/papaparse.min.js"></script>
  <script src= "https://cdn.jsdelivr.net/npm/fflate/umd/index.js"></script>
  <script src="analysis.js"></script>
  <script src="shapePopup.js"></script>
  <script src="main.js"></script>
  <script src="graph.js"></script>
  <script src="locationScore.js"></script>
  <link rel="stylesheet" href="libs/MarkerCluster.Default.css"/>
  <script src="libs/leaflet.markercluster.js"></script>  

</body>
</html>
